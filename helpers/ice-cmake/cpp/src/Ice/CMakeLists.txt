add_library(ice)

set(GENERATED_ICE_SOURCES
	${GENERATED_SOURCE_DIR}/Ice/BuiltinSequences.cpp
	${GENERATED_SOURCE_DIR}/Ice/BuiltinSequences.h
	${GENERATED_SOURCE_DIR}/Ice/BuiltinSequencesI.cpp
	${GENERATED_SOURCE_DIR}/Ice/BuiltinSequencesI.h
	${GENERATED_SOURCE_DIR}/Ice/Communicator.cpp
	${GENERATED_SOURCE_DIR}/Ice/Communicator.h
	${GENERATED_SOURCE_DIR}/Ice/CommunicatorF.cpp
	${GENERATED_SOURCE_DIR}/Ice/CommunicatorF.h
	${GENERATED_SOURCE_DIR}/Ice/CommunicatorFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/CommunicatorFI.h
	${GENERATED_SOURCE_DIR}/Ice/CommunicatorI.cpp
	${GENERATED_SOURCE_DIR}/Ice/CommunicatorI.h
	${GENERATED_SOURCE_DIR}/Ice/Connection.cpp
	${GENERATED_SOURCE_DIR}/Ice/Connection.h
	${GENERATED_SOURCE_DIR}/Ice/ConnectionF.cpp
	${GENERATED_SOURCE_DIR}/Ice/ConnectionF.h
	${GENERATED_SOURCE_DIR}/Ice/ConnectionFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ConnectionFI.h
	${GENERATED_SOURCE_DIR}/Ice/ConnectionI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ConnectionI.h
	${GENERATED_SOURCE_DIR}/Ice/Current.cpp
	${GENERATED_SOURCE_DIR}/Ice/Current.h
	${GENERATED_SOURCE_DIR}/Ice/CurrentI.cpp
	${GENERATED_SOURCE_DIR}/Ice/CurrentI.h
	${GENERATED_SOURCE_DIR}/Ice/Endpoint.cpp
	${GENERATED_SOURCE_DIR}/Ice/Endpoint.h
	${GENERATED_SOURCE_DIR}/Ice/EndpointF.cpp
	${GENERATED_SOURCE_DIR}/Ice/EndpointF.h
	${GENERATED_SOURCE_DIR}/Ice/EndpointFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/EndpointFI.h
	${GENERATED_SOURCE_DIR}/Ice/EndpointI.cpp
	${GENERATED_SOURCE_DIR}/Ice/EndpointI.h
	${GENERATED_SOURCE_DIR}/Ice/EndpointTypes.cpp
	${GENERATED_SOURCE_DIR}/Ice/EndpointTypes.h
	${GENERATED_SOURCE_DIR}/Ice/EndpointTypesI.cpp
	${GENERATED_SOURCE_DIR}/Ice/EndpointTypesI.h
	${GENERATED_SOURCE_DIR}/Ice/EventLoggerMsg.h
	${GENERATED_SOURCE_DIR}/Ice/EventLoggerMsg.rc
	${GENERATED_SOURCE_DIR}/Ice/FacetMap.cpp
	${GENERATED_SOURCE_DIR}/Ice/FacetMap.h
	${GENERATED_SOURCE_DIR}/Ice/FacetMapI.cpp
	${GENERATED_SOURCE_DIR}/Ice/FacetMapI.h
	${GENERATED_SOURCE_DIR}/Ice/Identity.cpp
	${GENERATED_SOURCE_DIR}/Ice/Identity.h
	${GENERATED_SOURCE_DIR}/Ice/IdentityI.cpp
	${GENERATED_SOURCE_DIR}/Ice/IdentityI.h
	${GENERATED_SOURCE_DIR}/Ice/ImplicitContext.cpp
	${GENERATED_SOURCE_DIR}/Ice/ImplicitContext.h
	${GENERATED_SOURCE_DIR}/Ice/ImplicitContextF.cpp
	${GENERATED_SOURCE_DIR}/Ice/ImplicitContextF.h
	${GENERATED_SOURCE_DIR}/Ice/ImplicitContextFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ImplicitContextFI.h
	${GENERATED_SOURCE_DIR}/Ice/ImplicitContextI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ImplicitContextI.h
	${GENERATED_SOURCE_DIR}/Ice/Instrumentation.cpp
	${GENERATED_SOURCE_DIR}/Ice/Instrumentation.h
	${GENERATED_SOURCE_DIR}/Ice/InstrumentationF.cpp
	${GENERATED_SOURCE_DIR}/Ice/InstrumentationF.h
	${GENERATED_SOURCE_DIR}/Ice/InstrumentationFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/InstrumentationFI.h
	${GENERATED_SOURCE_DIR}/Ice/InstrumentationI.cpp
	${GENERATED_SOURCE_DIR}/Ice/InstrumentationI.h
	${GENERATED_SOURCE_DIR}/Ice/LocalException.cpp
	${GENERATED_SOURCE_DIR}/Ice/LocalException.h
	${GENERATED_SOURCE_DIR}/Ice/LocalExceptionI.cpp
	${GENERATED_SOURCE_DIR}/Ice/LocalExceptionI.h
	${GENERATED_SOURCE_DIR}/Ice/Locator.cpp
	${GENERATED_SOURCE_DIR}/Ice/Locator.h
	${GENERATED_SOURCE_DIR}/Ice/LocatorF.cpp
	${GENERATED_SOURCE_DIR}/Ice/LocatorF.h
	${GENERATED_SOURCE_DIR}/Ice/LocatorFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/LocatorFI.h
	${GENERATED_SOURCE_DIR}/Ice/LocatorI.cpp
	${GENERATED_SOURCE_DIR}/Ice/LocatorI.h
	${GENERATED_SOURCE_DIR}/Ice/Logger.cpp
	${GENERATED_SOURCE_DIR}/Ice/Logger.h
	${GENERATED_SOURCE_DIR}/Ice/LoggerF.cpp
	${GENERATED_SOURCE_DIR}/Ice/LoggerF.h
	${GENERATED_SOURCE_DIR}/Ice/LoggerFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/LoggerFI.h
	${GENERATED_SOURCE_DIR}/Ice/LoggerI.cpp
	${GENERATED_SOURCE_DIR}/Ice/LoggerI.h
	${GENERATED_SOURCE_DIR}/Ice/Metrics.cpp
	${GENERATED_SOURCE_DIR}/Ice/Metrics.h
	${GENERATED_SOURCE_DIR}/Ice/MetricsI.cpp
	${GENERATED_SOURCE_DIR}/Ice/MetricsI.h
	${GENERATED_SOURCE_DIR}/Ice/MSG00001.bin
	${GENERATED_SOURCE_DIR}/Ice/ObjectAdapter.cpp
	${GENERATED_SOURCE_DIR}/Ice/ObjectAdapter.h
	${GENERATED_SOURCE_DIR}/Ice/ObjectAdapterF.cpp
	${GENERATED_SOURCE_DIR}/Ice/ObjectAdapterF.h
	${GENERATED_SOURCE_DIR}/Ice/ObjectAdapterFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ObjectAdapterFI.h
	${GENERATED_SOURCE_DIR}/Ice/ObjectAdapterI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ObjectAdapterI.h
	${GENERATED_SOURCE_DIR}/Ice/ObjectFactory.cpp
	${GENERATED_SOURCE_DIR}/Ice/ObjectFactory.h
	${GENERATED_SOURCE_DIR}/Ice/ObjectFactoryI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ObjectFactoryI.h
	${GENERATED_SOURCE_DIR}/Ice/Plugin.cpp
	${GENERATED_SOURCE_DIR}/Ice/Plugin.h
	${GENERATED_SOURCE_DIR}/Ice/PluginF.cpp
	${GENERATED_SOURCE_DIR}/Ice/PluginF.h
	${GENERATED_SOURCE_DIR}/Ice/PluginFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/PluginFI.h
	${GENERATED_SOURCE_DIR}/Ice/PluginI.cpp
	${GENERATED_SOURCE_DIR}/Ice/PluginI.h
	${GENERATED_SOURCE_DIR}/Ice/Process.cpp
	${GENERATED_SOURCE_DIR}/Ice/Process.h
	${GENERATED_SOURCE_DIR}/Ice/ProcessF.cpp
	${GENERATED_SOURCE_DIR}/Ice/ProcessF.h
	${GENERATED_SOURCE_DIR}/Ice/ProcessFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ProcessFI.h
	${GENERATED_SOURCE_DIR}/Ice/ProcessI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ProcessI.h
	${GENERATED_SOURCE_DIR}/Ice/Properties.cpp
	${GENERATED_SOURCE_DIR}/Ice/Properties.h
	${GENERATED_SOURCE_DIR}/Ice/PropertiesAdmin.cpp
	${GENERATED_SOURCE_DIR}/Ice/PropertiesAdmin.h
	${GENERATED_SOURCE_DIR}/Ice/PropertiesAdminI.cpp
	${GENERATED_SOURCE_DIR}/Ice/PropertiesAdminI.h
	${GENERATED_SOURCE_DIR}/Ice/PropertiesF.cpp
	${GENERATED_SOURCE_DIR}/Ice/PropertiesF.h
	${GENERATED_SOURCE_DIR}/Ice/PropertiesFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/PropertiesFI.h
	${GENERATED_SOURCE_DIR}/Ice/PropertiesI.cpp
	${GENERATED_SOURCE_DIR}/Ice/PropertiesI.h
	${GENERATED_SOURCE_DIR}/Ice/RemoteLogger.cpp
	${GENERATED_SOURCE_DIR}/Ice/RemoteLogger.h
	${GENERATED_SOURCE_DIR}/Ice/RemoteLoggerI.cpp
	${GENERATED_SOURCE_DIR}/Ice/RemoteLoggerI.h
	${GENERATED_SOURCE_DIR}/Ice/Router.cpp
	${GENERATED_SOURCE_DIR}/Ice/Router.h
	${GENERATED_SOURCE_DIR}/Ice/RouterF.cpp
	${GENERATED_SOURCE_DIR}/Ice/RouterF.h
	${GENERATED_SOURCE_DIR}/Ice/RouterFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/RouterFI.h
	${GENERATED_SOURCE_DIR}/Ice/RouterI.cpp
	${GENERATED_SOURCE_DIR}/Ice/RouterI.h
	${GENERATED_SOURCE_DIR}/Ice/ServantLocator.cpp
	${GENERATED_SOURCE_DIR}/Ice/ServantLocator.h
	${GENERATED_SOURCE_DIR}/Ice/ServantLocatorF.cpp
	${GENERATED_SOURCE_DIR}/Ice/ServantLocatorF.h
	${GENERATED_SOURCE_DIR}/Ice/ServantLocatorFI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ServantLocatorFI.h
	${GENERATED_SOURCE_DIR}/Ice/ServantLocatorI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ServantLocatorI.h
	${GENERATED_SOURCE_DIR}/Ice/SliceChecksumDict.cpp
	${GENERATED_SOURCE_DIR}/Ice/SliceChecksumDict.h
	${GENERATED_SOURCE_DIR}/Ice/SliceChecksumDictI.cpp
	${GENERATED_SOURCE_DIR}/Ice/SliceChecksumDictI.h
	${GENERATED_SOURCE_DIR}/Ice/ValueFactory.cpp
	${GENERATED_SOURCE_DIR}/Ice/ValueFactory.h
	${GENERATED_SOURCE_DIR}/Ice/ValueFactoryI.cpp
	${GENERATED_SOURCE_DIR}/Ice/ValueFactoryI.h
	${GENERATED_SOURCE_DIR}/Ice/Version.cpp
	${GENERATED_SOURCE_DIR}/Ice/Version.h
	${GENERATED_SOURCE_DIR}/Ice/VersionI.cpp
	${GENERATED_SOURCE_DIR}/Ice/VersionI.h
)

set(ICE_SLICES
	${SLICE_DIR}/Ice/BuiltinSequences.ice
	${SLICE_DIR}/Ice/Communicator.ice
	${SLICE_DIR}/Ice/CommunicatorF.ice
	${SLICE_DIR}/Ice/Connection.ice
	${SLICE_DIR}/Ice/ConnectionF.ice
	${SLICE_DIR}/Ice/Current.ice
	${SLICE_DIR}/Ice/Endpoint.ice
	${SLICE_DIR}/Ice/EndpointF.ice
	${SLICE_DIR}/Ice/EndpointTypes.ice
	${SLICE_DIR}/Ice/FacetMap.ice
	${SLICE_DIR}/Ice/Identity.ice
	${SLICE_DIR}/Ice/ImplicitContext.ice
	${SLICE_DIR}/Ice/ImplicitContextF.ice
	${SLICE_DIR}/Ice/Instrumentation.ice
	${SLICE_DIR}/Ice/InstrumentationF.ice
	${SLICE_DIR}/Ice/LocalException.ice
	${SLICE_DIR}/Ice/Locator.ice
	${SLICE_DIR}/Ice/LocatorF.ice
	${SLICE_DIR}/Ice/Logger.ice
	${SLICE_DIR}/Ice/LoggerF.ice
	${SLICE_DIR}/Ice/Metrics.ice
	${SLICE_DIR}/Ice/ObjectAdapter.ice
	${SLICE_DIR}/Ice/ObjectAdapterF.ice
	${SLICE_DIR}/Ice/ObjectFactory.ice
	${SLICE_DIR}/Ice/Plugin.ice
	${SLICE_DIR}/Ice/PluginF.ice
	${SLICE_DIR}/Ice/Process.ice
	${SLICE_DIR}/Ice/ProcessF.ice
	${SLICE_DIR}/Ice/Properties.ice
	${SLICE_DIR}/Ice/PropertiesAdmin.ice
	${SLICE_DIR}/Ice/PropertiesF.ice
	${SLICE_DIR}/Ice/RemoteLogger.ice
	${SLICE_DIR}/Ice/Router.ice
	${SLICE_DIR}/Ice/RouterF.ice
	${SLICE_DIR}/Ice/ServantLocator.ice
	${SLICE_DIR}/Ice/ServantLocatorF.ice
	${SLICE_DIR}/Ice/SliceChecksumDict.ice
	${SLICE_DIR}/Ice/ValueFactory.ice
	${SLICE_DIR}/Ice/Version.ice
)

set_source_files_properties(${GENERATED_ICE_SOURCES} PROPERTIES GENERATED TRUE)

target_sources(ice
   PRIVATE
	   Acceptor.cpp
	   Acceptor.h
	   AcceptorF.h
	   ACM.cpp
	   ACM.h
	   ACMF.h
	   Application.cpp
	   ArgVector.cpp
	   ArgVector.h
	   AsyncResult.cpp
	   Base64.cpp
	   Base64.h
	   BatchRequestQueue.cpp
	   BatchRequestQueue.h
	   Buffer.cpp
	   CollocatedRequestHandler.cpp
	   CollocatedRequestHandler.h
	   CommunicatorI.cpp
	   CommunicatorI.h
	   Cond.cpp
	   ConnectionFactory.cpp
	   ConnectionFactory.h
	   ConnectionFactoryF.h
	   ConnectionI.cpp
	   ConnectionI.h
	   ConnectionRequestHandler.cpp
	   ConnectionRequestHandler.h
	   Connector.cpp
	   Connector.h
	   ConnectorF.h
	   ConnectRequestHandler.cpp
	   ConnectRequestHandler.h
	   ConnectRequestHandlerF.h
	   CountDownLatch.cpp
	   DefaultsAndOverrides.cpp
	   DefaultsAndOverrides.h
	   DefaultsAndOverridesF.h
	   DispatchInterceptor.cpp
	   DLLMain.cpp
	   DynamicLibrary.cpp
	   EndpointFactory.cpp
	   EndpointFactory.h
		EndpointFactoryF.h
		EventLoggerMsg.mc
	   EventHandler.cpp
	   EventHandler.h
	   EventHandlerF.h
	   Exception.cpp
	   FactoryTable.cpp
	   FactoryTableInit.cpp
	   GCObject.cpp
	   HashUtil.h
	   HttpParser.cpp
	   HttpParser.h
	   Ice.rc
	   IconvStringConverter.cpp
	   ImplicitContextI.cpp
	   ImplicitContextI.h
	   Incoming.cpp
	   IncomingAsync.cpp
	   IncomingRequest.h
	   Initialize.cpp
	   InputStream.cpp
	   Instance.cpp
	   Instance.h
	   InstrumentationI.cpp
	   InstrumentationI.h
	   IPEndpointI.cpp
	   IPEndpointI.h
	   IPEndpointIF.h
	   LocalObject.cpp
	   LocatorInfo.cpp
	   LocatorInfo.h
	   LocatorInfoF.h
	   LoggerAdminI.cpp
	   LoggerAdminI.h
	   LoggerI.cpp
	   LoggerI.h
	   LoggerUtil.cpp
	   MetricsAdminI.cpp
	   MetricsObserverI.cpp
	   Network.cpp
	   Network.h
	   NetworkF.h
	   NetworkProxy.cpp
	   NetworkProxy.h
	   NetworkProxyF.h
	   Object.cpp
	   ObjectAdapterFactory.cpp
	   ObjectAdapterFactory.h
	   ObjectAdapterFactoryF.h
	   ObjectAdapterI.cpp
	   ObjectAdapterI.h
	   ObserverHelper.cpp
	   OpaqueEndpointI.cpp
	   OpaqueEndpointI.h
	   OutgoingAsync.cpp
	   OutputStream.cpp
	   PluginManagerI.cpp
	   PluginManagerI.h
	   PropertiesAdminI.cpp
	   PropertiesAdminI.h
	   PropertiesI.cpp
	   PropertiesI.h
	   PropertyNames.cpp
	   PropertyNames.h
	   Protocol.cpp
	   ProtocolInstance.cpp
	   ProtocolInstance.h
	   ProtocolInstanceF.h
	   ProtocolPluginFacade.cpp
	   ProtocolPluginFacade.h
	   ProtocolPluginFacadeF.h
	   Proxy.cpp
	   ProxyFactory.cpp
	   ProxyFactory.h
	   Reference.cpp
	   Reference.h
	   ReferenceFactory.cpp
	   ReferenceFactory.h
	   ReferenceFactoryF.h
	   RegisterPluginsInit.cpp
	   RegisterPluginsInit.h
	   ReplyStatus.h
	   RequestHandler.cpp
	   RequestHandler.h
	   RequestHandlerFactory.cpp
	   RequestHandlerFactory.h
	   ResponseHandler.cpp
	   ResponseHandler.h
	   RetryQueue.cpp
	   RetryQueue.h
	   RetryQueueF.h
	   RouterInfo.cpp
	   RouterInfo.h
	   RouterInfoF.h
	   Selector.cpp
	   Selector.h
	   ServantManager.cpp
	   ServantManager.h
	   Service.cpp
	   SHA1.cpp
	   SharedContext.h
	   SliceChecksums.cpp
	   SlicedData.cpp
	   StreamSocket.cpp
	   StreamSocket.h
	   StringConverterPlugin.cpp
	   StringUtil.h
	   SysLoggerI.cpp
	   SysLoggerI.h
	   SystemdJournalI.cpp
	   SystemdJournalI.h
	   TcpAcceptor.cpp
	   TcpAcceptor.h
	   TcpConnector.cpp
	   TcpConnector.h
	   TcpEndpointI.cpp
	   TcpEndpointI.h
	   TcpTransceiver.cpp
	   TcpTransceiver.h
	   Thread.cpp
	   ThreadPool.cpp
	   ThreadPool.h
	   Timer.cpp
	   TraceLevels.cpp
	   TraceLevels.h
	   TraceLevelsF.h
	   TraceUtil.cpp
	   TraceUtil.h
	   Transceiver.cpp
	   Transceiver.h
	   TransceiverF.h
	   UdpConnector.cpp
	   UdpConnector.h
	   UdpEndpointI.cpp
	   UdpEndpointI.h
	   UdpTransceiver.cpp
	   UdpTransceiver.h
	   Value.cpp
	   ValueFactoryManagerI.cpp
	   ValueFactoryManagerI.h
	   VirtualShared.h
	   WSAcceptor.cpp
	   WSAcceptor.h
	   WSConnector.cpp
	   WSConnector.h
	   WSEndpoint.cpp
	   WSEndpoint.h
	   WSTransceiver.cpp
		WSTransceiver.h
		${GENERATED_ICE_SOURCES}
		${ICE_SLICES}
)

target_include_directories(ice 
   PRIVATE 
      ${CMAKE_SOURCE_DIR}/cpp/include
	   ${CMAKE_SOURCE_DIR}/cpp/src
      ${GENERATED_SOURCE_DIR}
      ${GENERATED_SOURCE_DIR}/Ice
)

if(CMAKE_CXX_STANDARD EQUAL 11)
	set(ICELIB_COMPILE_DEFS "${ICE_CPP11_COMPILE_DEFS}")
	set(CMAKE_RC_FLAGS ${ICE_RC_FLAGS})
else()
	set(ICELIB_COMPILE_DEFS "${ICE_CPP98_COMPILE_DEFS")
endif()

if(WIN32)
	if(MSVC)
		source_group(
			TREE ${CMAKE_CURRENT_SOURCE_DIR}
			PREFIX "Resource Files" 
			FILES
				${CMAKE_CURRENT_SOURCE_DIR}/EventLoggerMsg.mc
				${CMAKE_CURRENT_SOURCE_DIR}/Ice.rc
		)

		source_group(
			TREE ${SLICE_DIR}/Ice
			PREFIX "Slice Files"
			FILES ${ICE_SLICES}
		)

		target_compile_options(ice PRIVATE 
			"/wd4996" 
			${ICE_COMPILE_OPTIONS} 
		)

		if(BUILD_SHARED_LIBS)
			set(ICELIB_COMPILE_DEFS "${ICELIB_COMPILE_DEFS}" "ICE_API_EXPORTS")
		endif()
		
		target_compile_definitions(ice PRIVATE 
			${ICELIB_COMPILE_DEFS}
		)

		if(BUILD_SHARED_LIBS)
			target_link_libraries(ice
				PRIVATE
					advapi32.lib
					ws2_32.lib
					Iphlpapi.lib
					rpcrt4.lib
					DbgHelp.lib
					Shlwapi.lib
			)
		endif()
		
		add_custom_command(TARGET ice
			COMMAND ${CMAKE_MC_COMPILER} ${CMAKE_CURRENT_SOURCE_DIR}/EventLoggerMsg.mc
			WORKING_DIRECTORY ${GENERATED_SOURCE_DIR}/Ice
			PRE_BUILD
		)
	endif()
endif()

add_dependencies(ice slice2cpp)

#function(CompileSlices slice2_bin slice_path slice_dir slice_target output_dir lang_std)
CompileSlices(slice2cpp
   ${SLICE_DIR}
   Ice
   ice
	${GENERATED_SOURCE_DIR}/Ice
	--impl-c++${CMAKE_CXX_STANDARD}
)

install(TARGETS ice DESTINATION lib)
